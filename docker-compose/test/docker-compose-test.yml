services:
  redis:
    container_name: horizon-redis
    image: redis:7.0.14
    environment:
      - REDIS_PASSWORD=1234
    command: [ "redis-server", "--requirepass", "1234" ]
    ports:
      - 36379:6379
    extends:
      file: common-test.yml
      service: horizon-base-config

  account-db:
    container_name: horizon-account-db
    image: mysql:8.2.0
    ports:
      - 10004:3306
    environment:
      MYSQL_DATABASE: accounts
    extends:
      file: common-test.yml
      service: horizon-db-config

  transaction-db:
    container_name: horizon-transaction-db
    image: mysql:8.2.0
    ports:
      - 10005:3306
    environment:
      MYSQL_DATABASE: transactions
    extends:
      file: common-test.yml
      service: horizon-db-config

  bank-db:
    container_name: horizon-bank-db
    image: mysql:8.2.0
    ports:
      - 10000:3306
    environment:
      MYSQL_DATABASE: banks
    extends:
      file: common-test.yml
      service: horizon-db-config

  user-db:
    container_name: horizon-user-db
    image: mysql:8.2.0
    ports:
      - 10001:3306
    environment:
      MYSQL_DATABASE: users
    extends:
      file: common-test.yml
      service: horizon-db-config

  dwolla-db:
    container_name: horizon-dwolla-db
    image: mysql:8.2.0
    ports:
      - 10002:3306
    environment:
      MYSQL_DATABASE: dwolla
    extends:
      file: common-test.yml
      service: horizon-db-config

  plaid-db:
    container_name: horizon-plaid-db
    image: mysql:8.2.0
    ports:
      - 10003:3306
    environment:
      MYSQL_DATABASE: plaid
    extends:
      file: common-test.yml
      service: horizon-db-config

  configserver:
    container_name: horizon-config-server
    image: dbroccoli/config-server:latest
    ports:
      - 9000:8080
    healthcheck:
      test: "curl --fail --silent localhost:8080/actuator/health/readiness | grep UP || exit 1"
      timeout: 10s
      retries: 20
      interval: 2s
      start_period: 3s
    environment:
      SPRING_PROFILES_ACTIVE: test
      SPRING_CONFIG_IMPORT: configserver:http://configserver:8080/
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 1234
    depends_on:
      redis:
        condition: service_healthy
    extends:
      file: common-test.yml
      service: horizon-base-config

  eureka-server:
    container_name: horizon-eureka-server
    image: dbroccoli/horizon/eureka-server:latest
    ports:
      - 9002:8080
    healthcheck:
      test: "curl --fail --silent localhost:8080/actuator/health/readiness | grep UP || exit 1"
      timeout: 10s
      retries: 20
      interval: 2s
      start_period: 3s
    environment:
      SPRING_PROFILES_ACTIVE: test
      SPRING_CONFIG_IMPORT: eureka:http://eureka:8080/
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 1234
    extends:
      file: common-test.yml
      service: horizon-base-config

  gateway:
    container_name: horizon-gateway
    image: dbroccoli/horizon/gateway:latest
    ports:
      - 9005:8080
    environment:
      SPRING_APPLICATION_NAME: "gateway"
    depends_on:
      eureka-server:
        condition: service_healthy
      configserver:
        condition: service_healthy
    extends:
      file: common-test.yml
      service: horizon-base-config

  account:
    container_name: horizon-account
    image: dbroccoli/horizon/account:latest
    ports:
      - 9007:8080
    environment:
      SPRING_APPLICATION_NAME: "account"
      SPRING_DATASOURCE_URL: "jdbc:mysql://account-db:3306/accounts"
    depends_on:
      account-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      configserver:
        condition: service_healthy
    extends:
      file: common-test.yml
      service: horizon-base-config

  transaction:
    container_name: horizon-transaction
    image: dbroccoli/horizon/transaction:latest
    ports:
      - 9008:8080
    environment:
      SPRING_APPLICATION_NAME: "transaction"
      SPRING_DATASOURCE_URL: "jdbc:mysql://transaction-db:3306/transactions"
    depends_on:
      transaction-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      configserver:
        condition: service_healthy
    extends:
      file: common-test.yml
      service: horizon-base-config

  bank:
    container_name: horizon-bank
    image: dbroccoli/horizon/bank:latest
    ports:
      - 9001:8080
    environment:
      SPRING_APPLICATION_NAME: "bank"
      SPRING_DATASOURCE_URL: "jdbc:mysql://bank-db:3306/banks"
    depends_on:
      bank-db:
        condition: service_healthy
      configserver:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    extends:
      file: common-test.yml
      service: horizon-base-config

  user:
    container_name: horizon-user
    image: dbroccoli/horizon/user:latest
    ports:
      - 9002:8080
    environment:
      SPRING_APPLICATION_NAME: "user"
      SPRING_DATASOURCE_URL: "jdbc:mysql://user-db:3306/users"
    depends_on:
      user-db:
        condition: service_healthy
      configserver:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    extends:
      file: common-test.yml
      service: horizon-base-config

  dwolla:
    container_name: horizon-dwolla
    image: dbroccoli/horizon/dwolla:latest
    ports:
      - 9003:8080
    environment:
      SPRING_APPLICATION_NAME: "dwolla"
      SPRING_DATASOURCE_URL: "jdbc:mysql://dwolla-db:3306/dwolla"
    depends_on:
      dwolla-db:
        condition: service_healthy
      configserver:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    extends:
      file: common-test.yml
      service: horizon-base-config

  plaid:
    container_name: horizon-plaid
    image: dbroccoli/horizon/plaid:latest
    ports:
      - 9004:8080
    environment:
      SPRING_APPLICATION_NAME: "plaid"
      SPRING_DATASOURCE_URL: "jdbc:mysql://plaid-db:3306/plaid"
    depends_on:
      plaid-db:
        condition: service_healthy
      configserver:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    extends:
      file: common-test.yml
      service: horizon-base-config

networks:
  horizon-test-network:
    driver: "bridge"
    name: "horizon-test-network"
